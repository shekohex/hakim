Problem

OpenCode/OpenChamber start via `coder_script` after workspace creation. Interactive terminals work, but OpenChamber's built-in git UI runs `git commit/push` in an environment where Elixir tooling (mix/hex) fails (pre-commit hooks).

What changed already

- `coder/modules/opencode/main.tf`: run install/start scripts via `bash -lc` and CLI app via `bash -lc "opencode"`
- `coder/modules/openchamber/main.tf`: run install/start scripts via `bash -lc`

Why this can still fail

- `bash -lc` only guarantees env init for the *module start process*.
- OpenChamber's git UI likely spawns `git` with an explicitly constructed env (common in Node runtimes), which can drop/override `MIX_HOME`/`HEX_HOME`/`MIX_ARCHIVES` even if the parent OpenChamber process has them.
- In that case `mix` can still be found, but it will resolve its home to something other than `/home/coder/.mix` (or point to a read-only mise location), so Hex/Rebar are “missing” and hooks error with messages like `mix local.hex --force`.
- The integrated terminal works because it runs a proper login/interactive shell that sources `/etc/profile.d/*` (mise + elixir-mix), fixes PATH, and sets MIX/HEX vars.

Observed failure signature

- Error includes `Mix requires the Hex package manager` and prompts `Shall I install Hex? (if running non-interactively, use "mix local.hex --force")`, plus BEAM load errors like `Error loading module 'Elixir.Hex': corrupt atom table`.
- This strongly suggests the git-hook `mix` process is using a different (and possibly read-only or partially-populated) Mix home than the interactive terminal.

Goal

Make `git` (and its hooks) succeed when invoked by OpenChamber/OpenCode UIs, without requiring an interactive terminal.

Recommended fix (robust, non-shell dependent)

1) Make MIX/HEX dirs always writable regardless of shell init
   - Export these at process start for module servers (defensive):
      - In `coder/modules/openchamber/scripts/start.sh` and `coder/modules/opencode/scripts/start.sh`, add at top:
        - `export MIX_HOME=/home/coder/.mix`
        - `export HEX_HOME=/home/coder/.hex`
        - `export MIX_ARCHIVES=/home/coder/.mix/archives`
    - Also source `/etc/profile` defensively (in case future callers stop using `bash -lc`):
      - `[ -f /etc/profile ] && . /etc/profile`

2) Propagate env defaults at container/agent level (removes reliance on `/etc/profile`)
   - Add defaults into the container+agent env so they exist for non-shell-spawned processes:
     - `coder/templates/hakim/main.tf`
       - Create `local.default_env` with explicit paths (since Docker env does not expand `$HOME`):
         - `MIX_HOME=/home/coder/.mix`
         - `HEX_HOME=/home/coder/.hex`
         - `MIX_ARCHIVES=/home/coder/.mix/archives`
       - Merge `local.default_env` into `coder_agent.main.env` and `docker_container.workspace.env` (ideally by folding into `local.combined_env`).
   - This directly addresses the observed `mix local.hex --force` prompt by forcing a consistent Mix home.

3) Ensure Hex/Rebar are installed in that Mix home (idempotent)
   - In `devcontainers/.devcontainer/features/src/elixir/install.sh`, after tool installation, ensure for the target user:
     - `MIX_HOME=/home/coder/.mix HEX_HOME=/home/coder/.hex MIX_ARCHIVES=/home/coder/.mix/archives mix local.hex --force`
     - `... mix local.rebar --force`
   - Keep it conditional if possible (only run if Hex archive missing), but `--force` is acceptable if this runs only at image build.

4) Fallback (only if env-only pass still fails)
   - Create a `/usr/local/bin/git` wrapper that exports `HOME=/home/coder` and `MIX_HOME/HEX_HOME/MIX_ARCHIVES` then `exec /usr/bin/git "$@"`.
   - Implement only in elixir images (e.g., via `devcontainers/.devcontainer/features/src/elixir/install.sh`) to reduce blast radius.

5) (Optional) handle minimal PATHs
   - If we see `mix`/`elixir` missing in non-interactive contexts, add `/usr/bin` symlinks:
      - In `devcontainers/.devcontainer/features/src/elixir/install.sh` after the existing symlink step:
        - Link `/usr/bin/mix` -> `/usr/local/bin/mix` (same for `elixir`, `erl` if needed).

Verification

- From OpenChamber git UI: run commit/push that triggers pre-commit hook using `mix`; it should succeed.
- In the workspace (non-interactive), validate Mix home consistency:
  - `env -i PATH=/usr/local/bin:/usr/bin:/bin HOME=/home/coder MIX_HOME=/home/coder/.mix HEX_HOME=/home/coder/.hex MIX_ARCHIVES=/home/coder/.mix/archives mix local.hex --force`
  - `env -i PATH=/usr/local/bin:/usr/bin:/bin HOME=/home/coder MIX_HOME=/home/coder/.mix HEX_HOME=/home/coder/.hex MIX_ARCHIVES=/home/coder/.mix/archives mix hex.info`

Files to change

- devcontainers/.devcontainer/features/src/elixir/install.sh
- coder/modules/openchamber/scripts/start.sh
- coder/modules/opencode/scripts/start.sh
- (conditional) coder/templates/hakim/main.tf
