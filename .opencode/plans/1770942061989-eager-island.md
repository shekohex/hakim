# Fix Hakim LXC Templates for Proxmox Compatibility

## Problem Summary
The hakim LXC templates are built with a nested archive structure that Proxmox cannot handle:
```
hakim-{variant}.tar.xz
  ├── rootfs.tar.xz (actual filesystem)
  └── meta.tar.xz (LXC metadata)
```

Proxmox expects the rootfs directly, not nested. When `pct create` extracts the template, it can't find `/sbin/init` because it's inside the nested `rootfs.tar.xz`.

## Root Cause
The build script at `distrobuilder/scripts/build.sh` (lines 224-225) wraps the distrobuilder output:
```bash
cd "${tmp_dir}"
tar -cJf "${out_dir}/${artifact_name}" rootfs.tar.xz meta.tar.xz
```

## Proposed Solutions

### Option A: Fix at Build Time (Recommended)
Modify the build process to output Proxmox-compatible templates:
1. For Proxmox: output just `rootfs.tar.xz` content directly
2. Keep metadata separate as `{artifact_name}.meta.tar.xz`
3. Update GitHub Actions to upload both files
4. Update documentation

**Pros:**
- Templates work with Proxmox natively
- No runtime extraction needed
- Clean, simple solution

**Cons:**
- Changes artifact format
- May need version bump

### Option B: Fix at Download Time
Add logic to extract the nested archive when downloading to Proxmox:
1. Download the nested archive
2. Extract `rootfs.tar.xz` from it
3. Use the extracted rootfs for container creation

**Pros:**
- Backward compatible with existing releases
- No rebuild needed

**Cons:**
- More complex
- Requires shell execution on Proxmox node
- Slower (download + extract + repack)

### Option C: Hybrid Approach
1. Update build script to output Proxmox-compatible format going forward
2. Add a migration script/note for existing templates

## Recommendation
**Option A** - Fix at build time. It's cleaner and the right long-term solution.

## Files to Modify
1. `distrobuilder/scripts/build.sh` - Change packaging logic
2. `.github/workflows/build-lxc-templates.yml` - Upload both rootfs and metadata
3. `coder/templates/hakim-proxmox/main.tf` - Update download URLs to point to rootfs-only artifact
4. `coder/templates/hakim-proxmox/README.md` - Document the artifact format

## Verification Steps
1. Build a test template: `./distrobuilder/scripts/build.sh --variant base`
2. Verify structure: `tar -tzf out/base/hakim-base-*.tar.xz | head -5`
   - Should show: `bin/`, `etc/`, `usr/`, etc. (NOT `rootfs.tar.xz`)
3. Test in Proxmox:
   ```bash
   pct create 999 local:vztmpl/hakim-base-*.tar.xz --ostype debian
   pct start 999
   pct exec 999 -- ls /sbin/init
   ```

## Questions for User
1. Do you prefer Option A (fix build) or Option B (fix download)?
2. Should we maintain backward compatibility with the nested format for non-Proxmox uses?
3. Should this be a new major/minor version bump for the templates?
