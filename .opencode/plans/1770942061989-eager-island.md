# Hakim Proxmox Workspaces: Stabilization + OCI Direction Research

## What We Did So Far (High-Level)
We iterated on 2 parallel tracks:

1) **Distrobuilder-built LXC templates** (the `.tar.xz` rootfs used by Proxmox `pct create`).
2) **Coder Proxmox Terraform template** (`coder/templates/hakim-proxmox/main.tf`) that creates/starts a CT and bootstraps the Coder agent via SSH `remote-exec`.

### Stabilization fixes (done over multiple commits)
- Proxmox template cache correctness: ensure the artifact actually used by `pct create` is the one we built/copied into `/var/lib/vz/template/cache`.
- Networking: ensure `/etc/network/interfaces` exists and `eth0` has DHCP config (so Proxmox DHCP works and Terraform can discover IP).
- Bootstrap reliability:
  - install `openssh-server` in LXC images
  - make Terraform discover CT IP robustly (don’t assume `eth0` key exists)
  - fix Coder binary download URL joining (ensure `/bin/coder-linux-*` URL is correct)
  - avoid recursive `chown -R /home/coder` because `lost+found` on a dedicated mount can fail in unprivileged CTs
- Lifecycle semantics:
  - CT no longer deleted on stop (avoid `count = start_count`); instead it persists and toggles `started` on Coder start/stop.
  - optional dedicated `/home/coder` mount point to persist user data across OS rebuilds.

### Known pain points we ran into
- Proxmox `ostype=debian` gating rejected Debian 13.x templates on older PVE (error: `unsupported debian version '13.3'`).
- `ostype=unmanaged` allowed Debian 13 rootfs creation but prevented Proxmox from injecting SSH keys/password (so our SSH bootstrap had to be done another way).
- Root password inside built Debian 13 images remained locked (`root:*` in `/etc/shadow`) until we explicitly set it during image build.

## New Research: PVE OCI Image Support
Proxmox’s own documentation now states it supports OCI images (technology preview) and converts OCI images into its LXC stack:

- Proxmox wiki (`Linux_Container`) explicitly describes OCI image support and that OCI images can be pulled from a registry via the UI (“Pull from OCI registry”) and then used to create a container, with the image “automatically converted to the LXC stack”.
  - Source: https://pve.proxmox.com/wiki/Linux_Container

Implication:
- We can potentially stop producing `vztmpl` tarballs ourselves and instead publish OCI images (which we already do for DevContainers) and let Proxmox pull/convert.

## Provider Constraint (Important)
The Terraform provider we use (`bpg/proxmox`) currently documents `proxmox_virtual_environment_download_file.content_type` as **only** `iso`, `import`, or `vztmpl`.
- Source: https://raw.githubusercontent.com/bpg/terraform-provider-proxmox/main/docs/resources/virtual_environment_download_file.md

Implication:
- Even if Proxmox supports OCI images, Terraform automation may need one of:
  - manual “Pull from OCI registry” step in Proxmox UI + use `custom_template_file_id`
  - or host-side automation (API/CLI) via hook scripts / external steps
  - or upgrading/changing provider if/when OCI is supported.

## Research: “Remove distrobuilder, reuse our Docker/OCI images”
We already publish OCI images to GHCR:
- `ghcr.io/shekohex/hakim-base`, `ghcr.io/shekohex/hakim-tooling`, and `ghcr.io/shekohex/hakim-<variant>`.

But these DevContainer images are not 1:1 drop-in replacements for system LXC templates:
- they are designed for DevContainer usage (no `systemd`/no `sshd` by default), while our current Proxmox-Coder flow expects a system container where we can SSH in and run `systemctl ...` during bootstrap.

If we pursue OCI-on-Proxmox, we likely need a deliberate choice:

### Path A (System Container): Keep system semantics
- Build/publish OCI images that behave like “system containers” (include init/sshd, sane defaults) OR keep distrobuilder.
- Terraform remains close to today’s flow.

### Path B (Application Container): Make Coder agent PID1
- Use OCI images as application containers; run `coder agent` as the container init/entrypoint.
- Remove SSH bootstrap and `remote-exec` entirely.
- Requires a different Proxmox configuration model (how to set entrypoint/init cmd for LXC created from OCI conversion) and a different Terraform approach.

## Recommendation (Planning)
You chose **OCI first**. The goal is to remove the entire SSH/bootstrap fragility and converge on a single image pipeline (our existing GHCR OCI images).

Key idea:
- **Let Proxmox pull/convert OCI** (tech preview) and then use Terraform to create the CT.
- Avoid SSH bootstrap entirely by using provider-supported knobs:
  - `environment_variables` (pass `CODER_AGENT_TOKEN`, `CODER_AGENT_URL`, etc.)
  - `hook_script_file_id` (optional) for host-side `pct exec` bootstrap if needed
  - Source: https://raw.githubusercontent.com/bpg/terraform-provider-proxmox/main/docs/resources/virtual_environment_container.md

## Execution Plan (Next Phase)
### Phase 1: OCI feasibility spike (manual first)
1) In Proxmox UI, on a storage that hosts container templates, use **Pull from OCI registry** to pull one image:
   - `ghcr.io/shekohex/hakim-elixir:latest` (or any variant)
   - Source (PVE Admin Guide 9.1.2): `11.3.2` / `11.3.3` describe OCI images + the “Pull from OCI registry” button.
2) Create a test CT from that OCI image in the UI.
3) Record:
   - the resulting template identifier (the `template_file_id` format)
   - whether Proxmox preserves OCI `ENTRYPOINT/CMD` (what runs as PID1)
   - whether networking, mounts, and user accounts behave acceptably.

### Phase 2: Make Hakim OCI images “Coder-agent-native”
Goal: a CT created from the OCI image comes up with the Coder agent automatically (no SSH/remote-exec).

1) Add an entrypoint/wrapper in our OCI images that:
   - ensures `coder` user exists
   - ensures `/home/coder` exists (and is safe with a mounted volume)
   - runs `coder agent` when `CODER_AGENT_TOKEN` + `CODER_AGENT_URL` are present
2) Update `scripts/build.sh` / CI to publish these OCI images with stable tags.

### Phase 3: Terraform changes to consume OCI templates
1) Update `coder/templates/hakim-proxmox/main.tf` to:
   - reference the pulled OCI template id (via `custom_template_file_id` or a new parameter)
   - use `environment_variables` to pass the agent token and url into the CT init process
   - remove `terraform_data.ssh_bootstrap` entirely (or keep as fallback)
2) Keep the persistent CT + optional `/home/coder` volume model.

### Phase 4: Decide whether to retire distrobuilder
- If OCI works well: distrobuilder becomes optional/legacy.
- If OCI is limited/unstable (tech preview): keep distrobuilder for “system CT” images, but still switch bootstrap away from SSH (hookscript approach).

## Verification (Once We Implement)
- Create a workspace end-to-end from Coder:
  - CT created and started
  - SSH bootstrap succeeds without manual steps
  - coder agent connects and apps/modules come online
- Stop/start workspace in Coder:
  - CT persists (no delete)
  - `/home/coder` volume persists if enabled
