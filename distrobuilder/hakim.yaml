image:
  distribution: debian
  release: bookworm
  architecture: amd64
  variant: base

source:
  downloader: debootstrap
  url: http://deb.debian.org/debian
  variant: minbase

mappings:
  architecture_map: debian

targets:
  lxc:
    create_message: Hakim {{ image.variant }} template for {{ image.release }} ({{ image.architecture }})

packages:
  manager: apt
  update: true
  cleanup: true
  sets:
    - action: install
      packages:
        - bash
        - sudo
        - curl
        - wget
        - jq
        - unzip
        - git
        - openssh-client
        - ca-certificates
        - gnupg
        - lsb-release
        - locales
        - build-essential
        - gawk
        - procps
        - lsof
        - htop
        - libsecret-1-0
        - pkg-config
        - make
        - tar
        - perl
        - xz-utils

files:
  - generator: copy
    source: scripts/actions
    path: /usr/local/share/hakim/actions
  - generator: copy
    source: ../devcontainers/base/install-mise.sh
    path: /usr/local/share/hakim/assets/install-mise.sh
    mode: "0755"
  - generator: copy
    source: ../devcontainers/base/mise.toml
    path: /usr/local/share/hakim/assets/mise.toml
  - generator: copy
    source: ../devcontainers/base/starship.toml
    path: /usr/local/share/hakim/assets/starship.toml
  - generator: copy
    source: ../devcontainers/base/tasks/postinstall
    path: /etc/mise/tasks/postinstall
    mode: "0755"
  - generator: copy
    source: ../devcontainers/base/tasks/expose-tools
    path: /etc/mise/tasks/expose-tools
    mode: "0755"
  - generator: copy
    source: ../devcontainers/base/tasks/setup-starship
    path: /etc/mise/tasks/setup-starship
    mode: "0755"
  - generator: copy
    source: ../devcontainers/base/tasks/setup-zoxide
    path: /etc/mise/tasks/setup-zoxide
    mode: "0755"
  - generator: copy
    source: ../devcontainers/base/tasks/setup-blesh
    path: /etc/mise/tasks/setup-blesh
    mode: "0755"
  - generator: copy
    source: ../devcontainers/.devcontainer/features/src/elixir/install.sh
    path: /usr/local/share/hakim/assets/features/elixir-install.sh
    mode: "0755"
  - generator: copy
    source: ../devcontainers/.devcontainer/features/src/phoenix/install.sh
    path: /usr/local/share/hakim/assets/features/phoenix-install.sh
    mode: "0755"
  - generator: copy
    source: ../devcontainers/.devcontainer/features/src/postgresql-tools/install.sh
    path: /usr/local/share/hakim/assets/features/postgresql-tools-install.sh
    mode: "0755"
  - generator: copy
    source: ../devcontainers/.devcontainer/features/src/lazyvim/install.sh
    path: /usr/local/share/hakim/assets/features/lazyvim-install.sh
    mode: "0755"
  - generator: copy
    source: ../devcontainers/.devcontainer/features/laravel/install.sh
    path: /usr/local/share/hakim/assets/features/laravel-install.sh
    mode: "0755"
  - path: /etc/default/locale
    generator: dump
    content: |
      LANG=en_US.UTF-8
      LANGUAGE=en_US.UTF-8
      LC_ALL=en_US.UTF-8
  - path: /etc/profile.d/mise.sh
    generator: dump
    mode: "0755"
    content: |
      export MISE_INSTALL_PATH=/usr/local/bin/mise
      export MISE_DATA_DIR=/usr/local/share/mise
      export MISE_CONFIG_DIR=/etc/mise
      export PATH="/usr/local/share/mise/shims:$PATH"
  # Mount mise cache from host if available (directory must exist, can be empty)
  - generator: copy
    source: cache/mise/downloads
    path: /usr/local/share/mise/downloads
    mode: "0755"

actions:
  - trigger: post-files
    action: |-
      #!/bin/bash
      set -euo pipefail
      /bin/bash /usr/local/share/hakim/actions/post-unpack.sh

  - trigger: post-files
    action: |-
      #!/bin/bash
      set -uo pipefail
      # Ensure mise downloads directory exists with proper permissions
      # Handle both regular directories and symlinks
      if [ ! -e /usr/local/share/mise/downloads ]; then
        mkdir -p /usr/local/share/mise/downloads
      fi
      chmod -R 777 /usr/local/share/mise/downloads 2>/dev/null || true
      # Make sure we can write to the parent directory too
      chmod 777 /usr/local/share/mise 2>/dev/null || true

  - trigger: post-files
    pongo: true
    action: |-
      #!/bin/bash
      set -euo pipefail
      /bin/bash /usr/local/share/hakim/actions/post-packages.sh {{ image.variant }}

  - trigger: post-files
    action: |-
      #!/bin/bash
      set -euo pipefail
      /bin/bash /usr/local/share/hakim/actions/post-files.sh
